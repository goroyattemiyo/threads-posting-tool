<script>
// insights screen templates and logic


App.renderAnalyticsContent = function() {
    var user = this.state.user || {};
    
    return '<div class="analytics-area">' +
      '<div class="card">' +
        '<div class="card-title">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</div>' +
        '<div style="display:flex;align-items:center;gap:12px;">' +
          (user.profilePicUrl ? '<img src="' + user.profilePicUrl + '" style="width:50px;height:50px;border-radius:50%;object-fit:cover;">' : '<div style="width:50px;height:50px;border-radius:50%;background:#eee;"></div>') +
          '<div>' +
            '<div style="font-weight:600;">@' + (user.username || '---') + '</div>' +
            '<div style="color:#666;font-size:14px;">Threads</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      
      '<div class="card">' +
        '<div class="card-title">éå»7æ—¥é–“ã®ã‚µãƒãƒªãƒ¼</div>' +
        '<div id="userInsightsContainer">' +
          '<div class="loading">' +
            '<div class="loading-spinner"></div>' +
            '<div>èª­ã¿è¾¼ã¿ä¸­...</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      
      '<div class="card">' +
        '<div class="card-title">æœ€è¿‘ã®æŠ•ç¨¿ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹</div>' +
        '<div id="postInsightsContainer">' +
          '<div class="loading">' +
            '<div class="loading-spinner"></div>' +
            '<div>èª­ã¿è¾¼ã¿ä¸­...</div>' +
          '</div>' +
        '</div>' +
      '</div>' +
      
       '<div class="card">' +
        '<div class="card-title">ãƒ“ãƒ¥ãƒ¼æ¨ç§»</div>' +
        '<div id="insightsChartContainer">' +
          '<div class="loading"><div class="loading-spinner"></div><div>èª­ã¿è¾¼ã¿ä¸­...</div></div>' +
        '</div>' +
      '</div>' +

      '<button id="refreshAnalyticsBtn" class="btn btn-secondary btn-full">ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°</button>' +
    '</div>';
  };

App.fetchInsights = function() {
    var self = this;
    
    this.api({ action: 'getInsights' })
      .then(function(result) {
        console.log('Insights result:', result);
        self.renderUserInsights(result.user);
        self.renderPostInsights(result.recentPosts);
      })
      .catch(function(error) {
        console.error('Insights error:', error);
        document.getElementById('userInsightsContainer').innerHTML = 
          '<div style="color:#666;text-align:center;padding:20px;">ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸ</div>';
        document.getElementById('postInsightsContainer').innerHTML = '';
      });
  };

App.renderUserInsights = function(data) {
    var container = document.getElementById('userInsightsContainer');
    if (!container) return;
    
    if (!data) {
      container.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      return;
    }
    
    container.innerHTML = 
      '<div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">' +
        '<div style="text-align:center;padding:16px;background:#f8f9fa;border-radius:12px;">' +
          '<div style="font-size:28px;font-weight:bold;color:#000;">' + (data.views || 0).toLocaleString() + '</div>' +
          '<div style="font-size:14px;color:#666;">ãƒ“ãƒ¥ãƒ¼</div>' +
        '</div>' +
        '<div style="text-align:center;padding:16px;background:#f8f9fa;border-radius:12px;">' +
          '<div style="font-size:28px;font-weight:bold;color:#000;">' + (data.followersCount || 0).toLocaleString() + '</div>' +
          '<div style="font-size:14px;color:#666;">ãƒ•ã‚©ãƒ­ãƒ¯ãƒ¼</div>' +
        '</div>' +
      '</div>' +
      '<div style="text-align:center;margin-top:12px;font-size:12px;color:#999;">' +
        'æœŸé–“: ' + (data.period ? new Date(data.period.since).toLocaleDateString() + ' ã€œ ' + new Date(data.period.until).toLocaleDateString() : '---') +
      '</div>';
  };

App.renderPostInsights = function(posts) {
  var container = document.getElementById('postInsightsContainer');
  if (!container) return;
  
  if (!posts || posts.length === 0) {
    container.innerHTML = '<div style="color:#666;text-align:center;padding:20px;">æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    return;
  }
  
  var html = '<div style="display:flex;flex-direction:column;gap:12px;max-height:400px;overflow-y:auto;">';
  
  posts.slice(0, 20).forEach(function(post) {
    // postedAt ã¾ãŸã¯ date ã‚’ä½¿ç”¨
    var dateStr = post.postedAt || post.date || '';
    var date = dateStr ? new Date(dateStr).toLocaleDateString() : '---';
    var text = post.text || post.postId || 'æŠ•ç¨¿';
    var displayText = text.length > 50 ? text.substring(0, 50) + '...' : text;
    
    html += 
      '<div style="padding:12px;background:#f8f9fa;border-radius:8px;">' +
        '<div style="font-size:13px;color:#333;margin-bottom:8px;">' + displayText + '</div>' +
        '<div style="display:flex;justify-content:space-between;align-items:center;">' +
          '<div style="font-size:12px;color:#999;">' + date + '</div>' +
          '<div style="display:flex;gap:12px;font-size:12px;color:#666;">' +
            '<span>ğŸ‘ ' + (post.views || 0) + '</span>' +
            '<span>â¤ï¸ ' + (post.likes || 0) + '</span>' +
            '<span>ğŸ’¬ ' + (post.replies || 0) + '</span>' +
          '</div>' +
        '</div>' +
      '</div>';
  });
  
  html += '</div>';
  container.innerHTML = html;
};

App.loadAnalytics = async function() {
  var self = this;
  
  // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
  document.querySelectorAll('.nav-item').forEach(function(item) {
    item.addEventListener('click', function() {
      var screen = this.getAttribute('data-screen');
      self.showScreen(screen);
    });
  });
  
  // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
  this.bindAccountSwitcherEvents();
  
  var refreshBtn = document.getElementById('refreshAnalyticsBtn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', function() {
      refreshBtn.disabled = true;
      refreshBtn.textContent = 'æ›´æ–°ä¸­...';
      self.loadAnalyticsData().then(function() {
        refreshBtn.disabled = false;
        refreshBtn.textContent = 'ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°';
      });
    });
  }
  
  await this.loadAnalyticsData();
};

App.loadAnalyticsData = async function() {
  var self = this;
  var userContainer = document.getElementById('userInsightsContainer');
  var postContainer = document.getElementById('postInsightsContainer');
  
  if (!userContainer || !postContainer) {
    console.error('ã‚³ãƒ³ãƒ†ãƒŠãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return;
  }
  
  userContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>èª­ã¿è¾¼ã¿ä¸­...</div></div>';
  postContainer.innerHTML = '<div class="loading"><div class="loading-spinner"></div><div>èª­ã¿è¾¼ã¿ä¸­...</div></div>';
  
  try {
    var insights = await this.api('getInsights', {});
    console.log('Insights result:', insights);
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚µã‚¤ãƒˆè¡¨ç¤º
    if (insights && insights.user) {
      this.renderUserInsights(insights.user);
    } else {
      userContainer.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
    }
    
    // æŠ•ç¨¿ã‚¤ãƒ³ã‚µã‚¤ãƒˆè¡¨ç¤º
      if (insights && insights.recentPosts && insights.recentPosts.length > 0) {
        this.renderPostInsights(insights.recentPosts);
      } else if (insights && insights.analyticsData && insights.analyticsData.length > 0) {
        
        // recentPostsãŒç©ºã®å ´åˆã¯analyticsDataã‚’ä½¿ç”¨
        this.renderPostInsights(insights.analyticsData);
      } else {
        postContainer.innerHTML = '<div style="text-align:center;color:#666;padding:20px;">æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
      }

    // â˜…Phase3: ã‚°ãƒ©ãƒ•æç”»
    var chartContainer = document.getElementById('insightsChartContainer');
    if (chartContainer && insights) {
      var chartSource = (insights.analyticsData && insights.analyticsData.length > 0) 
        ? insights.analyticsData 
        : insights.recentPosts;
      chartContainer.innerHTML = Phase3.renderInsightsChart(chartSource || []);
    }

    
  } catch (error) {
    console.error('Analytics error:', error);
    userContainer.innerHTML = '<div style="text-align:center;color:#e74c3c;padding:20px;">ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ</div>';
    postContainer.innerHTML = '';
  }
};

</script>