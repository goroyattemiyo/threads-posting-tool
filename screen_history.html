<script>
// history screen templates and logic


App.renderHistoryContent = function() {
    return '<div class="post-list">' +
    
    // å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºãƒˆã‚°ãƒ«
    '<div style="padding:16px 16px 0;">' +
      this.renderAllAccountsToggle() +
    '</div>' +
    
    '<div id="historyList">' +
      '<div class="loading">' +
        '<div class="loading-spinner"></div>' +
        '<div>èª­ã¿è¾¼ã¿ä¸­...</div>' +
      '</div>' +
    '</div>' +
    '</div>';
  };

App.loadHistory = async function() {
    var self = this;
    
    document.querySelectorAll('.nav-item').forEach(function(item) {
      item.addEventListener('click', function() {
        var screen = this.getAttribute('data-screen');
        self.showScreen(screen);
      });
    });
    
    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    this.bindAccountSwitcherEvents();
    
    // å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºãƒˆã‚°ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    this.bindAllAccountsToggleEvents(this.fetchHistory);
    
    console.log('=== loadHistory start ===');
    console.log('sheetId:', this.state.sheetId);
    
    await this.fetchHistory();
  };

App.fetchHistory = async function() {
    try {
      var history = await this.api('getHistory', { 
        showAllAccounts: this.state.showAllAccounts 
      });
      console.log('history received:', history);
      this.state.history = history || [];
      this.renderHistoryList();
    } catch (error) {
      console.error('loadHistory error:', error);
      this.state.history = [];
      this.renderHistoryList();
      this.showToast('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    }
  };

App.renderHistoryList = function() {
    var self = this;
    var container = document.getElementById('historyList');
    var history = this.state.history || [];
    
    if (history.length === 0) {
      container.innerHTML = '<div class="empty-state">' +
        '<div class="empty-state-icon">ğŸ“‹</div>' +
        '<div class="empty-state-title">æŠ•ç¨¿å±¥æ­´ã¯ã‚ã‚Šã¾ã›ã‚“</div>' +
        '<div class="empty-state-desc">æŠ•ç¨¿ã™ã‚‹ã¨å±¥æ­´ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</div>' +
      '</div>';
      return;
    }
    
    var html = '';
    history.forEach(function(item) {
      var postedDate = new Date(item.postedAt);
      var dateStr = postedDate.toLocaleString('ja-JP');
      
      // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ã®è¡¨ç¤º
      var mediaIndicator = '';
      if (item.mediaUrl) {
        if (item.mediaType === 'VIDEO') {
          mediaIndicator = '<span style="background:#9333ea;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">ğŸ¬ å‹•ç”»</span>';
        } else {
          mediaIndicator = '<span style="background:#2563eb;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">ğŸ“· ç”»åƒ</span>';
        }
      }
      
      // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
      var thumbnail = '';
      if (item.mediaUrl) {
        if (item.mediaType === 'VIDEO') {
          thumbnail = '<div style="margin:12px 0;">' +
            '<video src="' + item.mediaUrl + '" style="max-width:100%;max-height:200px;border-radius:8px;background:#000;" controls></video>' +
          '</div>';
        } else {
          thumbnail = '<div style="margin:12px 0;">' +
            '<img src="' + item.mediaUrl + '" style="max-width:100%;max-height:200px;border-radius:8px;object-fit:cover;">' +
          '</div>';
        }
      }
      
      // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ©ãƒ™ãƒ«ï¼ˆå…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºæ™‚ã®ã¿ï¼‰
      var accountLabel = '';
      if (self.state.showAllAccounts && item.accountUsername) {
        accountLabel = '<span class="account-label">@' + item.accountUsername + '</span>';
      }
      
      html += '<div class="post-item">' +
        '<div class="post-item-header">' +
          '<span class="post-item-status posted">æŠ•ç¨¿æ¸ˆã¿</span>' +
          accountLabel +
          mediaIndicator +
          '<span class="post-item-time">' + dateStr + '</span>' +
        '</div>' +
        '<div class="post-item-text">' + self.escapeHtml(item.text) + '</div>' +
        thumbnail +
      '</div>';
    });
    
    container.innerHTML = html;
  };

</script>