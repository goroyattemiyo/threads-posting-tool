<script>
// schedule screen templates and logic


App.renderScheduleContent = function() {
    var sheetId = this.state.sheetId || localStorage.getItem('threads_tool_sheet_id') || '';
    var sheetUrl = 'https://docs.google.com/spreadsheets/d/' + sheetId + '/edit';
  
    return '<div class="schedule-area">' +
    '<div class="card" style="background:#f0f9ff;margin-bottom:16px;">' +
      '<div style="font-size:13px;color:#1e40af;margin-bottom:8px;">' +
        'ğŸ’¡ æŠ•ç¨¿æ¸ˆã¿ã®äºˆç´„ã¯è‡ªå‹•ã§å±¥æ­´ã¸ç§»å‹•ã—ã¾ã™' +
      '</div>' +
      '<div style="font-size:12px;color:#666;">' +
        'â±ï¸ 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°ï¼ˆã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ç›´æ¥ç·¨é›†ã‚‚å¯èƒ½ï¼‰' +
      '</div>' +
    '</div>' +
    
    // å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºãƒˆã‚°ãƒ«
    this.renderAllAccountsToggle() +

    // â˜…Phase4: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼/ãƒªã‚¹ãƒˆåˆ‡æ›¿
    Phase4.renderCalendarToggle() +
    
    // â˜…Phase4: ãƒªãƒˆãƒ©ã‚¤æƒ…å ±
    Phase4.renderRetryInfo() +
    
    '<div class="post-list" id="scheduleList">' +
      '<div class="loading">' +
        '<div class="loading-spinner"></div>' +
        '<div>èª­ã¿è¾¼ã¿ä¸­...</div>' +
        '</div>' +
      '</div>' +
    '</div>';
  };

App.loadScheduledPosts = async function() {
    var self = this;
    
    // ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    document.querySelectorAll('.nav-item').forEach(function(item) {
      item.addEventListener('click', function() {
        var screen = this.getAttribute('data-screen');
        self.showScreen(screen);
      });
    });
    
    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåˆ‡ã‚Šæ›¿ãˆã‚¤ãƒ™ãƒ³ãƒˆ
    this.bindAccountSwitcherEvents();
    
    // å…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºãƒˆã‚°ãƒ«ã®ã‚¤ãƒ™ãƒ³ãƒˆ
    this.bindAllAccountsToggleEvents(this.fetchScheduledPosts);
    
    // æ—¢å­˜ã®ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚¯ãƒªã‚¢
    if (this.scheduleRefreshTimer) {
      clearInterval(this.scheduleRefreshTimer);
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    await this.fetchScheduledPosts();
    
    // 1åˆ†ã”ã¨ã«è‡ªå‹•æ›´æ–°
    this.scheduleRefreshTimer = setInterval(function() {
      if (self.state.currentScreen === 'schedule') {
        console.log('è‡ªå‹•æ›´æ–°: äºˆç´„æŠ•ç¨¿ã‚’å†èª­ã¿è¾¼ã¿');
        self.fetchScheduledPosts();
      } else {
        // åˆ¥ã®ç”»é¢ã«ç§»å‹•ã—ãŸã‚‰ã‚¿ã‚¤ãƒãƒ¼ã‚’åœæ­¢
        clearInterval(self.scheduleRefreshTimer);
      }
    }, 1 * 60 * 1000); // 1åˆ†
  };

App.fetchScheduledPosts = async function() {
    try {
      var posts = await this.api('getScheduledPosts', { 
        showAllAccounts: this.state.showAllAccounts 
      });
      this.state.posts = posts || [];
      this.renderScheduleList();
      // â˜…Phase4: ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼ã«ãƒ‡ãƒ¼ã‚¿ã‚’æ¸¡ã™ & åˆ‡æ›¿ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ³ãƒ‰
      Phase4.bindViewToggleEvents(this.state.posts);
    } catch (error) {
      this.state.posts = [];
      this.renderScheduleList();
      this.showToast('èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    }
  };

App.renderScheduleList = function() {
  var self = this;
  var container = document.getElementById('scheduleList');
  var posts = this.state.posts || [];
  
  posts = posts.filter(function(post) {
    return post.status !== 'posted';
  });

  if (posts.length === 0) {
    container.innerHTML = '<div class="empty-state">' +
      '<div class="empty-state-icon">ğŸ“…</div>' +
      '<div class="empty-state-title">äºˆç´„æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>' +
      '<div class="empty-state-desc">ã€ŒæŠ•ç¨¿ã€ã‚¿ãƒ–ã‹ã‚‰äºˆç´„ã§ãã¾ã™</div>' +
    '</div>';
    return;
  }
  
  var html = '';
  posts.forEach(function(post) {
    var scheduledDate = new Date(post.scheduledTime);
    var dateStr = scheduledDate.toLocaleString('ja-JP');
    
    // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
    var statusClass = 'scheduled';
    var statusText = 'äºˆç´„æ¸ˆã¿';
    if (post.status === 'error') {
      statusClass = 'error';
      statusText = 'âŒ å¤±æ•—';
    } else if (post.status === 'retrying') {
      statusClass = 'retrying';
      statusText = 'ğŸ”„ å†è©¦è¡Œä¸­';
    } else if (post.status === 'expired') {
      statusClass = 'error';
      statusText = 'â° æœŸé™åˆ‡ã‚Œ';
    }
    
    // ãƒ¡ãƒ‡ã‚£ã‚¢ã‚¿ã‚¤ãƒ—ã®è¡¨ç¤º
    var mediaIndicator = '';
    if (post.mediaUrl) {
      if (post.mediaType === 'VIDEO') {
        mediaIndicator = '<span style="background:#9333ea;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">ğŸ¬ å‹•ç”»</span>';
      } else {
        mediaIndicator = '<span style="background:#2563eb;color:white;padding:2px 6px;border-radius:4px;font-size:10px;margin-left:8px;">ğŸ“· ç”»åƒ</span>';
      }
    }
    
    // ã‚µãƒ ãƒã‚¤ãƒ«è¡¨ç¤º
    var thumbnail = '';
    if (post.mediaUrl) {
      if (post.mediaType === 'VIDEO') {
        thumbnail = '<div style="margin:8px 0;">' +
          '<video src="' + post.mediaUrl + '" style="max-width:100%;max-height:120px;border-radius:8px;background:#000;"></video>' +
        '</div>';
      } else {
        thumbnail = '<div style="margin:8px 0;">' +
          '<img src="' + post.mediaUrl + '" style="max-width:100%;max-height:120px;border-radius:8px;object-fit:cover;">' +
        '</div>';
      }
    }
    
    // ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
    var errorBox = '';
    if (post.status === 'error' && post.errorMessage) {
      errorBox = '<div style="background:#fee2e2;border:1px solid #fecaca;border-radius:8px;padding:8px;margin:8px 0;font-size:12px;color:#dc2626;">' +
        '<strong>ã‚¨ãƒ©ãƒ¼:</strong> ' + self.escapeHtml(post.errorMessage) +
      '</div>';
    }
    
    // ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³
    var actions = '<div class="post-item-actions" style="display:flex;gap:8px;flex-wrap:wrap;">';
    if (post.status === 'error') {
      actions += '<button class="btn btn-primary btn-small" onclick="App.retryPost(\'' + post.id + '\')">ğŸ”„ å†è©¦è¡Œ</button>';
    }
    actions += '<button class="btn btn-secondary btn-small" onclick="App.openEditModal(\'' + post.id + '\')">âœï¸ ç·¨é›†</button>';
    actions += '<button class="btn btn-danger btn-small" onclick="App.deletePost(\'' + post.id + '\')">ğŸ—‘ï¸ å‰Šé™¤</button>';
    actions += '</div>';
    
    // ã‚¢ã‚«ã‚¦ãƒ³ãƒˆãƒ©ãƒ™ãƒ«ï¼ˆå…¨ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¡¨ç¤ºæ™‚ã®ã¿ï¼‰
    var accountLabel = '';
    if (self.state.showAllAccounts && post.accountUsername) {
      accountLabel = '<span class="account-label">@' + post.accountUsername + '</span>';
    }
    
    html += '<div class="post-item" id="post-' + post.id + '" style="' + (post.status === 'error' ? 'border-left:3px solid #dc2626;' : '') + '">' +
      '<div class="post-item-header">' +
        '<span class="post-item-status ' + statusClass + '" style="' + (post.status === 'error' ? 'background:#fee2e2;color:#dc2626;' : '') + '">' + statusText + '</span>' +
        accountLabel +
        mediaIndicator +
        '<span class="post-item-time">' + dateStr + '</span>' +
      '</div>' +
      '<div class="post-item-text">' + self.escapeHtml(post.text) + '</div>' +
      thumbnail +
      errorBox +
      actions +
    '</div>';
  });
  
  container.innerHTML = html;
};



// ===========================================
// Phase 4: äºˆç´„å¯è¦–æ€§ & å®‰å®šæ€§ & ã‚³ãƒ³ãƒ†ãƒ³ãƒ„æ”¯æ´
// ===========================================

var Phase4 = {

  // -----------------------------------------
  // 4-1. ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ãƒ“ãƒ¥ãƒ¼
  // -----------------------------------------

  _calendarDate: null, // è¡¨ç¤ºä¸­ã®æœˆï¼ˆDateã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
  _calendarPosts: [],  // äºˆç´„æŠ•ç¨¿ãƒ‡ãƒ¼ã‚¿

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼è¡¨ç¤ºã‚¨ãƒªã‚¢HTML
  renderCalendarToggle: function() {
    return '<div class="view-toggle-area">' +
      '<div class="view-toggle">' +
        '<button type="button" class="view-toggle-btn active" data-view="list">ğŸ“‹ ãƒªã‚¹ãƒˆ</button>' +
        '<button type="button" class="view-toggle-btn" data-view="calendar">ğŸ“… ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</button>' +
      '</div>' +
    '</div>' +
    '<div id="calendarView" style="display:none;">' +
      '<div id="calendarContainer"></div>' +
    '</div>';
  },

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã‚’æç”»
  renderCalendar: function(posts) {
    this._calendarPosts = posts || [];

    if (!this._calendarDate) {
      this._calendarDate = new Date();
    }

    var container = document.getElementById('calendarContainer');
    if (!container) return;

    var year = this._calendarDate.getFullYear();
    var month = this._calendarDate.getMonth();

    // æœˆã®æƒ…å ±
    var firstDay = new Date(year, month, 1);
    var lastDay = new Date(year, month + 1, 0);
    var startDayOfWeek = firstDay.getDay(); // 0=æ—¥
    var daysInMonth = lastDay.getDate();

    var monthNames = ['1æœˆ', '2æœˆ', '3æœˆ', '4æœˆ', '5æœˆ', '6æœˆ', '7æœˆ', '8æœˆ', '9æœˆ', '10æœˆ', '11æœˆ', '12æœˆ'];

    // æ—¥ä»˜ã”ã¨ã®æŠ•ç¨¿æ•°ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
    var postsByDate = {};
    this._calendarPosts.forEach(function(post) {
      if (post.scheduledTime && post.status !== 'posted') {
        var d = new Date(post.scheduledTime);
        var key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
        if (!postsByDate[key]) postsByDate[key] = [];
        postsByDate[key].push(post);
      }
    });

    var today = new Date();
    var todayKey = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');

    // ãƒ˜ãƒƒãƒ€ãƒ¼
    var html = '<div class="cal-header">' +
      '<button type="button" class="cal-nav-btn" id="calPrev">â—€</button>' +
      '<div class="cal-month-label">' + year + 'å¹´ ' + monthNames[month] + '</div>' +
      '<button type="button" class="cal-nav-btn" id="calNext">â–¶</button>' +
    '</div>';

    // æ›œæ—¥ãƒ˜ãƒƒãƒ€ãƒ¼
    html += '<div class="cal-weekdays">';
    var weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
    weekdays.forEach(function(wd, i) {
      var color = i === 0 ? 'var(--error-color)' : (i === 6 ? 'var(--info-color)' : 'var(--text-tertiary)');
      html += '<div class="cal-weekday" style="color:' + color + ';">' + wd + '</div>';
    });
    html += '</div>';

    // æ—¥ä»˜ã‚°ãƒªãƒƒãƒ‰
    html += '<div class="cal-grid">';

    // å‰æœˆã®ç©ºç™½
    for (var blank = 0; blank < startDayOfWeek; blank++) {
      html += '<div class="cal-cell cal-cell-empty"></div>';
    }

    // æ—¥ä»˜ã‚»ãƒ«
    for (var day = 1; day <= daysInMonth; day++) {
      var dateKey = year + '-' + String(month + 1).padStart(2, '0') + '-' + String(day).padStart(2, '0');
      var dayPosts = postsByDate[dateKey] || [];
      var isToday = dateKey === todayKey;
      var dayOfWeek = new Date(year, month, day).getDay();

      var cellClass = 'cal-cell';
      if (isToday) cellClass += ' cal-cell-today';
      if (dayPosts.length > 0) cellClass += ' cal-cell-has-posts';

      var dayColor = '';
      if (dayOfWeek === 0) dayColor = 'color:var(--error-color);';
      if (dayOfWeek === 6) dayColor = 'color:var(--info-color);';

      html += '<div class="' + cellClass + '" data-date="' + dateKey + '">';
      html += '<div class="cal-day-num" style="' + dayColor + '">' + day + '</div>';

      if (dayPosts.length > 0) {
        // ãƒ‰ãƒƒãƒˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼
        var dotCount = Math.min(dayPosts.length, 3);
        html += '<div class="cal-dots">';
        for (var di = 0; di < dotCount; di++) {
          var dotColor = dayPosts[di].status === 'error' ? 'var(--error-color)' : 'var(--accent-color)';
          html += '<div class="cal-dot" style="background:' + dotColor + ';"></div>';
        }
        if (dayPosts.length > 3) {
          html += '<div class="cal-dot-more">+' + (dayPosts.length - 3) + '</div>';
        }
        html += '</div>';
      }

      html += '</div>';
    }

    // æœ«å°¾ã®ç©ºç™½
    var totalCells = startDayOfWeek + daysInMonth;
    var remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
    for (var rc = 0; rc < remainingCells; rc++) {
      html += '<div class="cal-cell cal-cell-empty"></div>';
    }

    html += '</div>';

    container.innerHTML = html;

    // ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ³ãƒ‰
    this.bindCalendarEvents();
  },

  // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã®ã‚¤ãƒ™ãƒ³ãƒˆ
  bindCalendarEvents: function() {
    var self = this;

    // å‰æœˆ/æ¬¡æœˆãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³
    var prevBtn = document.getElementById('calPrev');
    var nextBtn = document.getElementById('calNext');

    if (prevBtn) {
      prevBtn.addEventListener('click', function() {
        self._calendarDate.setMonth(self._calendarDate.getMonth() - 1);
        self.renderCalendar(self._calendarPosts);
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', function() {
        self._calendarDate.setMonth(self._calendarDate.getMonth() + 1);
        self.renderCalendar(self._calendarPosts);
      });
    }

    // æ—¥ä»˜ã‚»ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯
    document.querySelectorAll('.cal-cell[data-date]').forEach(function(cell) {
      cell.addEventListener('click', function() {
        var dateKey = this.getAttribute('data-date');
        self.showDayDetail(dateKey);
      });
    });
  },

  // æ—¥ä»˜ã®è©³ç´°ãƒ¢ãƒ¼ãƒ€ãƒ«
  showDayDetail: function(dateKey) {
    var self = this;
    var parts = dateKey.split('-');
    var dateLabel = parseInt(parts[1]) + 'æœˆ' + parseInt(parts[2]) + 'æ—¥';

    var dayPosts = this._calendarPosts.filter(function(p) {
      if (!p.scheduledTime || p.status === 'posted') return false;
      var d = new Date(p.scheduledTime);
      var k = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      return k === dateKey;
    });

    // æ™‚é–“é †ã«ã‚½ãƒ¼ãƒˆ
    dayPosts.sort(function(a, b) {
      return new Date(a.scheduledTime) - new Date(b.scheduledTime);
    });

    var overlay = document.createElement('div');
    overlay.id = 'dayDetailModal';
    overlay.style.cssText = 'position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;justify-content:center;align-items:center;z-index:1000;padding:20px;';

    var listHtml = '';
    if (dayPosts.length === 0) {
      listHtml = '<div style="text-align:center;padding:24px;color:var(--text-tertiary);">' +
        '<div style="font-size:14px;">äºˆç´„æŠ•ç¨¿ã¯ã‚ã‚Šã¾ã›ã‚“</div>' +
      '</div>';
    } else {
      dayPosts.forEach(function(post) {
        var time = new Date(post.scheduledTime);
        var timeStr = String(time.getHours()).padStart(2, '0') + ':' + String(time.getMinutes()).padStart(2, '0');
        var preview = (post.text || '').substring(0, 50);
        if ((post.text || '').length > 50) preview += '...';

        var statusDot = post.status === 'error'
          ? '<span style="color:var(--error-color);">â—</span>'
          : '<span style="color:var(--success-color);">â—</span>';

        var mediaIcon = '';
        if (post.mediaUrl) {
          mediaIcon = post.mediaType === 'VIDEO' ? ' ğŸ¬' : ' ğŸ“·';
        }

        listHtml += '<div style="padding:12px;border-bottom:1px solid var(--border-light);display:flex;gap:12px;align-items:flex-start;">' +
          '<div style="font-size:16px;font-weight:700;color:var(--text-primary);white-space:nowrap;min-width:48px;">' + timeStr + '</div>' +
          '<div style="flex:1;min-width:0;">' +
            '<div style="font-size:13px;color:var(--text-primary);line-height:1.5;">' +
              statusDot + ' ' + App.escapeHtml(preview) + mediaIcon +
            '</div>' +
            (post.status === 'error' ? '<div style="font-size:11px;color:var(--error-color);margin-top:2px;">ã‚¨ãƒ©ãƒ¼</div>' : '') +
          '</div>' +
          '<button class="day-detail-edit-btn btn btn-small btn-secondary" data-post-id="' + post.id + '" style="flex-shrink:0;">ç·¨é›†</button>' +
        '</div>';
      });
    }

    // æ–°è¦äºˆç´„ãƒœã‚¿ãƒ³
    var addBtnHtml = '<div style="padding:12px;">' +
      '<button id="dayDetailAddBtn" class="btn btn-primary btn-full" data-date="' + dateKey + '">ï¼‹ ã“ã®æ—¥ã«äºˆç´„ã‚’è¿½åŠ </button>' +
    '</div>';

    overlay.innerHTML =
      '<div style="background:var(--bg-primary);border-radius:var(--radius-xl);max-width:420px;width:100%;max-height:80vh;display:flex;flex-direction:column;overflow:hidden;">' +
        '<div style="padding:20px 20px 16px;border-bottom:1px solid var(--border-light);display:flex;justify-content:space-between;align-items:center;">' +
          '<h3 style="margin:0;font-size:18px;font-weight:700;">' + dateLabel + ' ã®äºˆç´„</h3>' +
          '<button id="closeDayDetail" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--text-tertiary);">âœ•</button>' +
        '</div>' +
        '<div style="overflow-y:auto;flex:1;">' + listHtml + '</div>' +
        addBtnHtml +
      '</div>';

    document.body.appendChild(overlay);

    // é–‰ã˜ã‚‹
    document.getElementById('closeDayDetail').addEventListener('click', function() {
      overlay.remove();
    });
    overlay.addEventListener('click', function(e) {
      if (e.target === overlay) overlay.remove();
    });

    // ç·¨é›†ãƒœã‚¿ãƒ³
    overlay.querySelectorAll('.day-detail-edit-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        var postId = this.getAttribute('data-post-id');
        overlay.remove();
        App.openEditModal(postId);
      });
    });

    // æ–°è¦äºˆç´„ãƒœã‚¿ãƒ³
    var addBtn = document.getElementById('dayDetailAddBtn');
    if (addBtn) {
      addBtn.addEventListener('click', function() {
        var targetDate = this.getAttribute('data-date');
        overlay.remove();
        // composeç”»é¢ã«é·ç§»ã—ã¦äºˆç´„ãƒ¢ãƒ¼ãƒ‰ã«ã™ã‚‹
        App.showScreen('compose');
        setTimeout(function() {
          // äºˆç´„ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿
          var scheduleOption = document.querySelector('.post-option[data-type="schedule"]');
          if (scheduleOption) scheduleOption.click();
          // æ—¥ä»˜ã‚’è¨­å®šï¼ˆ9:00ã«ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
          var scheduleTimeEl = document.getElementById('scheduleTime');
          if (scheduleTimeEl) {
            scheduleTimeEl.value = targetDate + 'T09:00';
          }
        }, 200);
      });
    }
  },

  // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆã®ã‚¤ãƒ™ãƒ³ãƒˆã‚’ãƒã‚¤ãƒ³ãƒ‰
  bindViewToggleEvents: function(posts) {
    var self = this;
    var toggleBtns = document.querySelectorAll('.view-toggle-btn');
    var listView = document.getElementById('scheduleList');
    var calendarView = document.getElementById('calendarView');

    if (!toggleBtns.length || !listView || !calendarView) return;

    toggleBtns.forEach(function(btn) {
      btn.addEventListener('click', function() {
        toggleBtns.forEach(function(b) { b.classList.remove('active'); });
        this.classList.add('active');

        var view = this.getAttribute('data-view');
        if (view === 'calendar') {
          listView.style.display = 'none';
          calendarView.style.display = 'block';
          self.renderCalendar(posts);
        } else {
          listView.style.display = 'block';
          calendarView.style.display = 'none';
        }
      });
    });
  },

  // -----------------------------------------
  // 4-2. ã‚¨ãƒ©ãƒ¼ãƒªãƒˆãƒ©ã‚¤ã®è‡ªå‹•åŒ–ï¼ˆãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã§å®Ÿè¡Œï¼‰
  //      ãƒ•ãƒ­ãƒ³ãƒˆå´: ãƒªãƒˆãƒ©ã‚¤è¨­å®šã®è¡¨ç¤º
  // -----------------------------------------

  renderRetryInfo: function() {
    return '<div style="background:var(--bg-tertiary);border-radius:var(--radius-sm);padding:10px 14px;font-size:12px;color:var(--text-secondary);margin-top:8px;">' +
      'ğŸ”„ ã‚¨ãƒ©ãƒ¼ã®æŠ•ç¨¿ã¯æœ€å¤§3å›ã¾ã§5åˆ†é–“éš”ã§è‡ªå‹•å†è©¦è¡Œã•ã‚Œã¾ã™' +
    '</div>';
  },

  // -----------------------------------------
  // Phase 4 åˆæœŸåŒ–
  // -----------------------------------------
  init: function() {
    console.log('Phase4 åˆæœŸåŒ–å®Œäº†');
  }
};

document.addEventListener('DOMContentLoaded', function() {
  Phase4.init();
});

</script>